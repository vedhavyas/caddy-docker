machine:
  services:
    - docker

dependencies:
  override:
    - docker run -v `pwd`:/$CIRCLE_PROJECT_REPONAME -w /$CIRCLE_PROJECT_REPONAME golang:latest bash -c "cd /$CIRCLE_PROJECT_REPONAME; ./build_caddy.sh"

test:
  override:
    - echo "No tests"

deployment:
  publish:
    branch: master
    commands:
      - tag=$CIRCLE_BRANCH-`git rev-parse --short HEAD`
      - docker build -t vedhavyas/caddy:$tag .
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push vedhavyas/caddy:latest